<!DOCTYPE html>
<html>
  <head>
    <title>My WAM Host</title>
    <meta charset="UTF-8" />
    <script src="coi-serviceworker.js"></script>
    <script type="module">
      let ctx = null;
      let pluginInstance = null;

      async function init() {
        console.log("Начинаю загрузку...");

        // Создаем контекст только после клика
        if (!ctx) ctx = new AudioContext();
        if (ctx.state === "suspended") await ctx.resume();

        try {
          // Убедись, что путь "./osc/index.js" верный относительно этого HTML
          const pluginUrl = "./osc/index.js";
          const { default: WamPlugin } = await import(pluginUrl);

          pluginInstance = await WamPlugin.createInstance(ctx);

          // Соединяем
          pluginInstance.audioNode.connect(ctx.destination);

          console.log("Плагин успешно загружен и подключен!", pluginInstance);
          alert("Плагин готов! Нажимай клавиши на миди-клаве.");
        } catch (e) {
          console.error("Ошибка загрузки плагина:", e);
        }
      }

      // Ждем полной загрузки DOM, прежде чем вешать событие на кнопку
      window.addEventListener("DOMContentLoaded", () => {
        const btn = document.getElementById("init-btn");
        if (btn) {
          btn.onclick = init;
        }

        // Запрос MIDI сразу при загрузке страницы
        if (navigator.requestMIDIAccess) {
          navigator
            .requestMIDIAccess()
            .then((midiAccess) => {
              console.log("Доступ к MIDI получен");
              for (var input of midiAccess.inputs.values()) {
                console.log("Подключено устройство:", input.name);
                input.onmidimessage = (msg) => {
                  if (pluginInstance) {
                    // Передаем MIDI данные в аудио-узел
                    pluginInstance.audioNode.onMidi(msg.data);
                  }
                };
              }
            })
            .catch((err) => console.error("MIDI недоступен:", err));
        } else {
          console.warn("Браузер не поддерживает Web MIDI API");
        }
      });
    </script>
  </head>
  <body>
    <button id="init-btn">Загрузить плагин и включить звук</button>
  </body>
</html>
